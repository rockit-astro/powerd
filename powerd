#!/usr/bin/env python3.4
#
# This file is part of powerd.
#
# powerd is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# powerd is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with powerd.  If not, see <http://www.gnu.org/licenses/>.

# pylint: disable=broad-except
# pylint: disable=too-few-public-methods

"""Frontend for interacting with the PDUs and UPSes via SNMP."""

import datetime
import Pyro4

from warwick.observatory.common import (
    daemons,
    log,
    IP)
from warwick.observatory.common.helpers import pyro_client_matches
from warwick.w1m.power import (
    DehumidifierSwitchDevice,
    Parameter,
    SNMPDevice,
    APCPDUSocket,
    APCUPSStatus,
    APCUPSBatteryRemaining,
    APCUPSBatteryHealthy,
    APCUPSOutputLoad,
    NetgearPoESocket)

# Machines that are allowed to issue power commands
CONTROL_IPS = [IP.OneMetreDome, IP.OneMetreTCS]

# Timeout in seconds for SNMP commands
SNMP_TIMEOUT = 2

RACK_PDU_IP = '10.2.6.212'
RACK_PDU_PORTS = [
    APCPDUSocket('rack_nuc', 1),
    APCPDUSocket('telescope_12v', 2),
    APCPDUSocket('telescope_80v', 3),
    APCPDUSocket('vaisala', 4),
    APCPDUSocket('monitor', 6),
    APCPDUSocket('light', 8)
]

TEL_PDU_IP = '10.2.6.213'
TEL_PDU_PORTS = [
    APCPDUSocket('red_camera', 1),
    APCPDUSocket('blue_camera', 2),
    APCPDUSocket('telescope_nuc', 3),
    APCPDUSocket('red_focus_motor', 7),
    APCPDUSocket('red_focus_controller', 8)
]

MAIN_UPS_IP = '10.2.6.210'
MAIN_UPS_PARAMETERS = [
    APCUPSStatus('main_ups_status'),
    APCUPSBatteryRemaining('main_ups_battery_remaining'),
    APCUPSBatteryHealthy('main_ups_battery_healthy'),
    APCUPSOutputLoad('main_ups_load'),
]

DOME_UPS_IP = '10.2.6.211'
DOME_UPS_PARAMETERS = [
    APCUPSStatus('dome_ups_status'),
    APCUPSBatteryRemaining('dome_ups_battery_remaining'),
    APCUPSBatteryHealthy('dome_ups_battery_healthy'),
    APCUPSOutputLoad('dome_ups_load'),
]

RACK_SWITCH_IP = '10.2.6.214'
RACK_SWITCH_PARAMETERS = [
    NetgearPoESocket('telescope_network', 1),
    NetgearPoESocket('webcam', 3),
    NetgearPoESocket('roomalert', 5),
    NetgearPoESocket('microphone', 7),
]

DEHUMIDIFIER_SERIAL_PORT = '/dev/dehumidifier'

class PowerDaemon:
    """Wraps a web request to the PDUs and UPSes"""
    def __init__(self):
        self._devices = [
            SNMPDevice(RACK_PDU_IP, RACK_PDU_PORTS, SNMP_TIMEOUT),
            SNMPDevice(TEL_PDU_IP, TEL_PDU_PORTS, SNMP_TIMEOUT),
            SNMPDevice(MAIN_UPS_IP, MAIN_UPS_PARAMETERS, SNMP_TIMEOUT),
            SNMPDevice(DOME_UPS_IP, DOME_UPS_PARAMETERS, SNMP_TIMEOUT),
            SNMPDevice(RACK_SWITCH_IP, RACK_SWITCH_PARAMETERS, SNMP_TIMEOUT),
            DehumidifierSwitchDevice(DEHUMIDIFIER_SERIAL_PORT, Parameter('dehumidifier'), self),
        ]

        # Map of parameter name to device holding the parameter
        self._device_by_parameter = {}
        for device in self._devices:
            for parameter in device.parameters:
                self._device_by_parameter.update({parameter.name: device})

    @Pyro4.expose
    def last_measurement(self):
        """Query the latest valid measurement.
        May return None if no data is available"""
        try:
            data = {'date': datetime.datetime.utcnow().strftime('%Y-%m-%dT%H:%M:%SZ')}
            for device in self._devices:
                data.update(device.status())
            return data

        except Exception as exception:
            print('{} ERROR: failed to query: {}' \
                  .format(datetime.datetime.utcnow(), str(exception)))
            log.error('powerd', 'Failed to query device (' \
                                  + str(exception) + ')')
            return None

    @Pyro4.expose
    def switch(self, name, enable):
        """Switch a named UPS switch parameter on or off"""
        if not pyro_client_matches(CONTROL_IPS):
            return False

        if name not in self._device_by_parameter:
            return False

        ret = self._device_by_parameter[name].set_parameter(name, enable)
        log.info('powerd', 'Switched ' + name + ' ' + ('on' if enable else 'off'))

        # Light status is also shown on dehumidifier box button
        if ret and name == 'light':
            self._device_by_parameter['dehumidifier'].set_light(enable)

        return ret

    @Pyro4.expose
    def value(self, name):
        """Query the value of a named parameter"""
        if name not in self._device_by_parameter:
            return False

        return self._device_by_parameter[name].get_parameter(name)

if __name__ == '__main__':
    daemons.onemetre_power.launch(PowerDaemon())
